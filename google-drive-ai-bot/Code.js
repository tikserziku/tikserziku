/**
 * üß† GOOGLE DRIVE AI ASSISTANT ‚Äî Apps Script Bot
 * 
 * –ü–æ–∏—Å–∫ –ø–æ Google Drive + Gemini 2.0 Flash + Telegram + –ü–∞–º—è—Ç—å –≤ Sheets
 *
 * –î–ï–ü–õ–û–ô: https://script.google.com ‚Üí New project ‚Üí –≤—Å—Ç–∞–≤–∏—Ç—å ‚Üí Deploy as Web App
 * –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å setTelegramWebhook()
 */

const CONFIG = {
  TELEGRAM_TOKEN: "7292379298:AAGbKpeqxM6hi3myCwgsx-h8OvbxX5Ignr0",
  GEMINI_API_KEY: "AIzaSyAufDRPAXjL126DMaqztnYt-qNoJF_CUS8",
  GEMINI_MODEL:   "gemini-2.0-flash",
  OWNER_CHAT_ID:  171656163,
  MEMORY_SHEET_ID: "",  // ‚Üê –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º, —Å–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  MAX_SEARCH_RESULTS: 10,
  MAX_FILE_CHARS: 3000,
  SYSTEM_PROMPT: `–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ Google Drive.
–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º.
–ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º —á–µ—Å—Ç–Ω–æ.`
};

function doPost(e) {
  try {
    const update = JSON.parse(e.postData.contents);
    if (!update.message?.text) return ContentService.createTextOutput("ok");
    const chatId = update.message.chat.id;
    const userId = update.message.from.id;
    const text   = update.message.text.trim();
    if (text.startsWith("/search ")) {
      handleSearch(chatId, userId, text.replace("/search ", ""));
    } else if (text === "/start") {
      sendTelegram(chatId, "üëã –ü—Ä–∏–≤–µ—Ç! –ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å ‚Äî –Ω–∞–π–¥—É –≤ Google Drive –∏ –æ—Ç–≤–µ—á—É —á–µ—Ä–µ–∑ Gemini.\n\n–ö–æ–º–∞–Ω–¥—ã: /search, /memory, /clear, /stats");
    } else if (text === "/memory") {
      showMemory(chatId, userId);
    } else if (text === "/clear") {
      clearMemory(userId);
      sendTelegram(chatId, "üßπ –ü–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞.");
    } else if (text === "/stats") {
      showStats(chatId);
    } else {
      handleQuestion(chatId, userId, text);
    }
  } catch(err) { Logger.log("doPost error: " + err); }
  return ContentService.createTextOutput("ok");
}

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({status:"running",timestamp:new Date().toISOString(),version:"1.0"})).setMimeType(ContentService.MimeType.JSON);
}

function handleQuestion(chatId, userId, question) {
  sendTelegram(chatId, "üîç –ò—â—É –≤ Google Drive...");
  saveMemory(userId, "Q: " + question);
  const files = searchDrive(question);
  if (files.length === 0) {
    const answer = askGemini("–ö–æ–Ω—Ç–µ–∫—Å—Ç: " + getMemory(userId), question);
    saveMemory(userId, "A: " + answer.substring(0, 200));
    sendTelegram(chatId, answer + "\n\n_(–¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ Drive –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)_");
    return;
  }
  sendTelegram(chatId, `üìÑ –ù–∞–π–¥–µ–Ω–æ ${files.length} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...`);
  const context = buildContext(files);
  const memory  = getMemory(userId, 3);
  const fullCtx = memory ? `–ò—Å—Ç–æ—Ä–∏—è:\n${memory}\n\n–î–æ–∫—É–º–µ–Ω—Ç—ã:\n${context}` : `–î–æ–∫—É–º–µ–Ω—Ç—ã:\n${context}`;
  const answer  = askGemini(fullCtx, question);
  saveMemory(userId, "A: " + answer.substring(0, 300));
  const sources = files.map((f,i) => `${i+1}. ${f.name} ‚Äî ${f.url}`).join("\n");
  sendTelegram(chatId, answer + "\n\nüìé –ò—Å—Ç–æ—á–Ω–∏–∫–∏:\n" + sources);
}

function handleSearch(chatId, userId, query) {
  sendTelegram(chatId, `üîç –ò—â—É: "${query}"`);
  const files = searchDrive(query);
  if (files.length === 0) { sendTelegram(chatId, "‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."); return; }
  const list = files.map((f,i) => `${i+1}. ${f.name}\n   ${f.url}`).join("\n\n");
  sendTelegram(chatId, `‚úÖ –ù–∞–π–¥–µ–Ω–æ ${files.length} —Ñ–∞–π–ª–æ–≤:\n\n${list}`);
}

function searchDrive(query) {
  const results = [];
  const safeQ = query.replace(/'/g, "\\'");
  const mimes = [
    "application/vnd.google-apps.document",
    "application/vnd.google-apps.spreadsheet"
  ];
  for (const mime of mimes) {
    try {
      const it = DriveApp.searchFiles(`fullText contains '${safeQ}' and mimeType = '${mime}' and trashed = false`);
      let n = 0;
      while (it.hasNext() && n < 5) {
        const f = it.next();
        results.push({id:f.getId(), name:f.getName(), type:mime.includes("document")?"doc":"sheet", url:f.getUrl(), modified:f.getLastUpdated().toLocaleDateString("ru-RU")});
        n++;
      }
    } catch(e) { Logger.log("search error: "+e); }
  }
  return results;
}

function readFileContent(fileId, fileType) {
  try {
    if (fileType === "doc") return DocumentApp.openById(fileId).getBody().getText().substring(0, CONFIG.MAX_FILE_CHARS);
    if (fileType === "sheet") return SpreadsheetApp.openById(fileId).getActiveSheet().getDataRange().getValues().slice(0,20).map(r=>r.join(" | ")).join("\n").substring(0, CONFIG.MAX_FILE_CHARS);
  } catch(e) { Logger.log("readFile error: "+e); }
  return "";
}

function buildContext(files) {
  return files.slice(0,5).map(f => {
    const content = readFileContent(f.id, f.type);
    return content ? `=== ${f.name} ===\n${content}` : "";
  }).filter(Boolean).join("\n\n") || "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.";
}

function askGemini(context, question) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.GEMINI_MODEL}:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
  try {
    const resp = UrlFetchApp.fetch(url, {
      method:"POST", contentType:"application/json", muteHttpExceptions:true,
      payload: JSON.stringify({
        system_instruction:{parts:[{text:CONFIG.SYSTEM_PROMPT}]},
        contents:[{parts:[{text:`–ö–æ–Ω—Ç–µ–∫—Å—Ç:\n${context}\n\n–í–æ–ø—Ä–æ—Å: ${question}`}]}],
        generationConfig:{temperature:0.7, maxOutputTokens:1024}
      })
    });
    const data = JSON.parse(resp.getContentText());
    if (data.error) return `‚ùå Gemini: ${data.error.message}`;
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞.";
  } catch(e) { return "‚ùå –û—à–∏–±–∫–∞ Gemini: " + e.message; }
}

function getMemorySheet() {
  if (!CONFIG.MEMORY_SHEET_ID) {
    const ss = SpreadsheetApp.create("AI Assistant Memory");
    CONFIG.MEMORY_SHEET_ID = ss.getId();
    ss.getActiveSheet().setName("Memory").getRange("A1:D1").setValues([["user_id","timestamp","role","text"]]);
    Logger.log("Memory sheet created: " + ss.getUrl());
    return ss.getActiveSheet();
  }
  return SpreadsheetApp.openById(CONFIG.MEMORY_SHEET_ID).getSheetByName("Memory");
}

function saveMemory(userId, text) {
  try { getMemorySheet().appendRow([userId.toString(), new Date().toISOString(), text.startsWith("Q:")?"user":"assistant", text.substring(0,500)]); } catch(e) { Logger.log("saveMemory: "+e); }
}

function getMemory(userId, lastN=6) {
  try {
    const data = getMemorySheet().getDataRange().getValues().slice(1).filter(r=>r[0].toString()===userId.toString()).slice(-lastN*2);
    return data.map(r=>r[3]).join("\n");
  } catch(e) { return ""; }
}

function clearMemory(userId) {
  try {
    const sheet = getMemorySheet();
    const data = sheet.getDataRange().getValues();
    for (let i=data.length-1; i>=1; i--) { if (data[i][0].toString()===userId.toString()) sheet.deleteRow(i+1); }
  } catch(e) { Logger.log("clearMemory: "+e); }
}

function showMemory(chatId, userId) {
  const m = getMemory(userId, 10);
  sendTelegram(chatId, m ? "üß† –ü–∞–º—è—Ç—å:\n\n"+m : "üì≠ –ü–∞–º—è—Ç—å –ø—É—Å—Ç–∞.");
}

function showStats(chatId) {
  try {
    const data = getMemorySheet().getDataRange().getValues().slice(1);
    sendTelegram(chatId, `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${new Set(data.map(r=>r[0])).size}\n‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π: ${data.length}\n‚Ä¢ –ú–æ–¥–µ–ª—å: ${CONFIG.GEMINI_MODEL}`);
  } catch(e) { sendTelegram(chatId, "‚ùå "+e.message); }
}

function sendTelegram(chatId, text, parseMode="") {
  const payload = {chat_id:chatId, text:text.substring(0,4096), disable_web_page_preview:true};
  if (parseMode) payload.parse_mode = parseMode;
  try { UrlFetchApp.fetch(`https://api.telegram.org/bot${CONFIG.TELEGRAM_TOKEN}/sendMessage`, {method:"POST", contentType:"application/json", payload:JSON.stringify(payload), muteHttpExceptions:true}); } catch(e) { Logger.log("sendTelegram: "+e); }
}

// ============ –£–¢–ò–õ–ò–¢–´ (–∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ) ============
function testDriveSearch() { Logger.log(JSON.stringify(searchDrive("–ø—Ä–æ–µ–∫—Ç"))); }
function testGemini() { Logger.log(askGemini("–¢–µ—Å—Ç.", "–ö–∞–∫ –¥–µ–ª–∞?")); }
function sendTestMessage() { sendTelegram(CONFIG.OWNER_CHAT_ID, "‚úÖ Apps Script –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!"); }
function setTelegramWebhook() {
  const url = ScriptApp.getService().getUrl();
  const r = UrlFetchApp.fetch(`https://api.telegram.org/bot${CONFIG.TELEGRAM_TOKEN}/setWebhook`, {method:"POST",contentType:"application/json",payload:JSON.stringify({url}),muteHttpExceptions:true});
  Logger.log("Webhook: " + r.getContentText() + "\nURL: " + url);
}
function removeTelegramWebhook() {
  UrlFetchApp.fetch(`https://api.telegram.org/bot${CONFIG.TELEGRAM_TOKEN}/deleteWebhook`,{method:"POST",muteHttpExceptions:true});
}
